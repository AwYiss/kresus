// Generated by CoffeeScript 1.7.1
var async;

async = require('async');

module.exports = function(app, server, callback) {
  var AllBanksData, Bank, CozyInstance;
  Bank = require('./models/bank');
  CozyInstance = require('./models/cozyinstance');
  AllBanksData = require("../tests/fixtures/banks-all.json");
  console.log("Maybe Adding banks...");
  Bank.all(function(err, banks) {
    var process;
    if (err) {
      console.error(err);
      return;
    }
    if ((banks != null ? banks.length : void 0) === 0) {
      process = function(bank, pcb) {
        return Bank.create({
          name: bank.name,
          uuid: bank.uuid
        }, pcb);
      };
      return async.each(AllBanksData, process, function(finalErr) {
        if (finalErr != null) {
          console.error("Error when adding bank: " + finalErr);
        } else {
          console.log("Success: All banks added.");
        }
        if (callback != null) {
          return callback(app, server);
        }
      });
    } else {
      console.log("Success: Banks were already present.");
      if (callback != null) {
        return callback(app, server);
      }
    }
  });
  console.log("Starting bank accounts polling...");
  require('./lib/accounts-poller').start();
  console.log("Starting alert watcher...");
  return require('./lib/report-manager').start();
};
